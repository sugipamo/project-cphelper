# AtCoder CLI ツール要件定義書

## 1. 概要

AtCoderのコンテスト問題の管理、テスト実行、提出を効率化するCLIツール

## 2. 基本機能要件

### 2.1 通常問題への対応
online-judge-toolsを利用した以下の機能を提供:
```
python3 cp.py <contest_id> <command> <problem_id> [options]
```
- o: 問題ファイルの作成とテストケースの取得
- t: テストケース実行（並列実行、タイムアウト5秒）
  - サンプルケースの実行
  - カスタムケースの自動生成と実行（`a_gen.py`が存在する場合）
    - `custom-1.in`/`custom-1.out`形式で保存
- s: AtCoderへの提出
  - ライブラリの自動マージ（lib/以下のimport文を検知）
  - 依存関係の解決とコード最適化

### 2.2 AHC特有の機能
```
python3 cp.py <contest_id> ahctest <number_of_cases>
```
- ツール類の自動セットアップ（本体、webvisualizer）
- テストケース生成と実行（seed値、in/out/other）
- Git/Cargoによるコード・ビジュアライザー管理

### 2.3 テスト機能
- 提出前の自動テスト実行
  - 全サンプルケースの実行
  - テスト失敗時の提出中止
  - 詳細なエラー情報の表示
- テストケースの管理
  - 自動ダウンロードと保存
  - カスタムテストケースの生成と実行
  - テストケースのキャッシュ管理
- カスタムテストケース
  - テストケースジェネレータの仕様
    - `{problem_id}_gen.py`ファイルの作成
    - `generate()`関数の実装（必須）
      - 戻り値: {'input': str, 'output': str}
    - `TESTCASE_NUM`変数の設定（オプション、デフォルト10）
    - 制約チェック機能の実装（オプション）
  - 生成されたテストケースの管理
    - `custom-{number}.in/out`形式での保存
    - テストケースの永続化と再利用
    - テストケースのバージョン管理
  - エラーハンドリング
    - 不正なテストケースの検出と報告
    - 生成エラーの適切な処理とリトライ
    - エラーログの保存
- 並列実行とタイムアウト
  - 最大5秒のタイムアウト設定
  - 複数テストケースの並列実行
  - リソース使用量の制限

### 2.4 ライブラリ管理
- Pythonライブラリの自動マージ機能
  - lib/ディレクトリ内のコードの自動検出
  - import文の解決と依存関係の管理
  - 循環参照の検出と防止
- テンプレート管理
  - 言語別のテンプレートファイル
  - カスタマイズ可能なテンプレート
  - テンプレートの自動更新機能

## 3. 実行環境

- Docker環境（CPU 2コア、メモリ1024MB）
  - Python (5082): python:3.10-slim
  - PyPy (5078, デフォルト): pypy:3.10-slim
  - Rust (5054): rust:1.70
  - 言語切替: `--rust`または`-rs`オプション
- 外部ツール: online-judge-tools, Cargo, Git

## 4. プロジェクト構成
```
ojt/
├── src/      # ツール本体
│   ├── commands.py     # コマンド処理
│   ├── config.py      # 設定管理
│   ├── ahc_tools.py   # AHC用ツール
│   ├── lib_merger.py  # ライブラリマージ
│   └── test_generator.py # テスト生成
├── tests/    # テストコード
│   ├── test_command_o.py
│   ├── test_command_t.py
│   ├── test_command_s.py
│   └── test_ahc.py
├── contest/  # 問題ファイル
│   ├── template/
│   │   ├── main.py    # Pythonテンプレート
│   │   ├── main.rs    # Rustテンプレート
│   │   └── gen.py     # テストケース生成テンプレート
│   ├── lib/     # 自動マージ対象のライブラリ
│   └── abc300/  # コンテストディレクトリ例
│       ├── a.py
│       ├── a_gen.py  # テストケースジェネレータ
│       └── test/
│           ├── sample-1.in   # サンプルケース
│           ├── sample-1.out
│           ├── custom-1.in   # 生成したテストケース
│           └── custom-1.out
├── .temp/    # 一時ファイル
├── pyproject.toml  # プロジェクト設定
├── compose.yml    # Docker設定
└── cp.py
```

## 5. 非機能要件
- エラー処理と認証管理
  - 適切なエラーメッセージの表示
  - エラーのログ記録
  - リトライ機能の実装
- 言語・ツールの拡張性
  - 新しい言語の追加が容易
  - ツールの設定変更が可能
  - プラグイン機能のサポート

## 6. 開発環境
- Python 3.10以上
  - pytest: テストフレームワーク
  - black: コードフォーマッタ
  - flake8: リンター
- Docker
  - マルチステージビルド
  - 軽量イメージの使用
- Git
  - バージョン管理
  - ブランチ戦略
  - CI/CD連携

## 7. セキュリティ要件
- 認証情報の管理
  - APIキーの安全な保存
  - 環境変数による設定
  - 認証情報の暗号化
- ファイル処理
  - テンポラリファイルの適切な削除
  - パーミッションの適切な設定
  - ファイルパスの検証
- エラー処理
  - センシティブ情報の非表示
  - 適切なログレベルの設定
  - セキュアなエラーメッセージ 